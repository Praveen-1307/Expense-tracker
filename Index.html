<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Expense Tracker</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f8fafc;
      margin: 0;
      padding: 30px;
    }

    .container {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    h1 {
      text-align: center;
      color: #2c3e50;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    button {
      background-color: #3498db;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background-color: #2980b9;
    }

    .expense-item {
      background: #f9f9f9;
      padding: 10px;
      border-left: 5px solid #3498db;
      margin-top: 10px;
      border-radius: 6px;
    }

    .total {
      font-weight: bold;
      margin-top: 20px;
      font-size: 18px;
    }

    .limit-exceeded {
      color: red;
      font-weight: bold;
      margin-top: 10px;
    }

    .section-title {
      margin-top: 30px;
      font-weight: bold;
      color: #2c3e50;
      font-size: 18px;
    }

    .card {
      margin-bottom: 20px;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .dark-mode {
      background-color: #181a1b !important;
      color: #f1f1f1 !important;
    }
  </style>
</head>
<body>

  <div class="container py-4">
    <div class="card p-4">
      <h1 class="text-center mb-4">üí∏ Expense Tracker</h1>
      <div id="limit-area">
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="month" class="form-label">Select Month</label>
            <input type="month" id="month" class="form-control">
          </div>
          <div class="col-md-6">
            <label for="limit" class="form-label">Monthly Limit (‚Çπ)</label>
            <input type="number" id="limit" class="form-control" placeholder="Enter limit...">
          </div>
        </div>
        <button class="btn btn-primary w-100 mb-3" onclick="setLimit()">Set Limit</button>
      </div>
      <div id="limit-message" class="mb-3" style="display:none;"></div>
      <div id="change-limit-btn" class="mb-3" style="display:none;">
        <button class="btn btn-secondary w-100" onclick="showLimitArea()">Change Limit/Month</button>
      </div>
      <div class="section-title">Add Expense</div>
      <div class="row g-3 mb-3">
        <div class="col-md-3"><input type="date" id="date" class="form-control"></div>
        <div class="col-md-3">
          <input type="text" id="category" class="form-control" placeholder="Category (e.g. Food)">
          <div id="recent-categories" class="mt-2"></div>
        </div>
        <div class="col-md-3"><input type="text" id="description" class="form-control" placeholder="Description"></div>
        <div class="col-md-3"><input type="number" id="amount" class="form-control" placeholder="Amount ‚Çπ"></div>
      </div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="recurring">
        <label class="form-check-label" for="recurring">Recurring Monthly</label>
      </div>
      <button class="btn btn-success w-100 mb-3" onclick="addExpense()">Add Expense</button>
      <div class="section-title">Monthly Report</div>
      <div id="expense-list"></div>
      <div class="total" id="total">Total: ‚Çπ0</div>
      <div class="limit-exceeded" id="limit-warning"></div>
      <button class="btn btn-outline-primary w-100 mb-3" onclick="downloadCSV()">‚¨áÔ∏è Download CSV</button>
      <div class="section-title">üí≥ Money Given to Friends</div>
      <div class="row g-3 mb-3">
        <div class="col-md-3"><input type="text" id="friend-name" class="form-control" placeholder="Friend's Name"></div>
        <div class="col-md-3"><input type="text" id="friend-desc" class="form-control" placeholder="Reason (e.g. Lunch Treat)"></div>
        <div class="col-md-3"><input type="number" id="friend-amount" class="form-control" placeholder="Amount ‚Çπ"></div>
        <div class="col-md-3"><input type="date" id="friend-date" class="form-control"></div>
      </div>
      <button class="btn btn-warning w-100 mb-3" onclick="addFriendTransaction()">Add Friend Transaction</button>
      <div id="friend-list"></div>
      <div class="total" id="friend-total">Total Given: ‚Çπ0</div>
      <div class="section-title">üí∞ Money Received from Friends</div>
      <div class="row g-3 mb-3">
        <div class="col-md-3"><input type="text" id="recv-friend-name" class="form-control" placeholder="Friend's Name"></div>
        <div class="col-md-3"><input type="text" id="recv-friend-desc" class="form-control" placeholder="Reason (e.g. Repayment)"></div>
        <div class="col-md-3"><input type="number" id="recv-friend-amount" class="form-control" placeholder="Amount ‚Çπ"></div>
        <div class="col-md-3"><input type="date" id="recv-friend-date" class="form-control"></div>
      </div>
      <button class="btn btn-success w-100 mb-3" onclick="addReceivedTransaction()">Add Received Transaction</button>
      <div id="recv-friend-list"></div>
      <div class="total" id="recv-friend-total">Total Received: ‚Çπ0</div>
    </div>
    <div class="text-center mt-3">
      <button class="btn btn-dark" onclick="toggleDarkMode()">Toggle Dark Mode</button>
      <button class="btn btn-danger mt-2" onclick="clearAllData()">Clear All Data</button>
    </div>
  </div>

  <script>
    // --- EXPENSES SECTION ---
    let expenses = JSON.parse(localStorage.getItem("expenses")) || [];
    let monthlyLimit = parseFloat(localStorage.getItem("monthlyLimit")) || 0;
    let currentMonth = localStorage.getItem("currentMonth") || "";
    let lastRecurringMonth = localStorage.getItem("lastRecurringMonth") || "";
    let recentCategories = JSON.parse(localStorage.getItem("recentCategories")) || [];

    // Preload month/limit
    if (currentMonth) document.getElementById("month").value = currentMonth;
    if (monthlyLimit) document.getElementById("limit").value = monthlyLimit;

    // --- Handle Recurring Expenses at Month Change ---
    function addRecurringExpensesIfNeeded() {
      const nowMonth = document.getElementById("month").value;
      if (!nowMonth) return;
      if (lastRecurringMonth === nowMonth) return;
      // Find recurring expenses from previous months
      const recurring = expenses.filter(e => e.recurring);
      // Only add if not already present for this month
      recurring.forEach(e => {
        const alreadyExists = expenses.some(ex => ex.recurring && ex.category === e.category && ex.description === e.description && ex.amount === e.amount && ex.date.startsWith(nowMonth));
        if (!alreadyExists) {
          // Add a new expense for this month
          expenses.push({
            date: nowMonth + "-01",
            category: e.category,
            description: e.description,
            amount: e.amount,
            recurring: true
          });
        }
      });
      lastRecurringMonth = nowMonth;
      localStorage.setItem("lastRecurringMonth", lastRecurringMonth);
      localStorage.setItem("expenses", JSON.stringify(expenses));
    }

    function setLimit() {
      const monthInput = document.getElementById("month").value;
      const limitInput = document.getElementById("limit").value;

      if (!monthInput || !limitInput) {
        alert("Please set both month and limit.");
        return;
      }

      currentMonth = monthInput;
      monthlyLimit = parseFloat(limitInput);

      localStorage.setItem("monthlyLimit", monthlyLimit);
      localStorage.setItem("currentMonth", currentMonth);
      addRecurringExpensesIfNeeded();
      displayExpenses();

      // Hide limit area and show limit message
      document.getElementById("limit-area").style.display = "none";
      const msg = document.getElementById("limit-message");
      msg.innerHTML = `<strong>Limit for the month: ‚Çπ${monthlyLimit.toFixed(2)}</strong>`;
      msg.style.display = "block";
      document.getElementById("change-limit-btn").style.display = "block";
    }

    function showLimitArea() {
      document.getElementById("limit-area").style.display = "block";
      document.getElementById("limit-message").style.display = "none";
      document.getElementById("change-limit-btn").style.display = "none";
    }

    function addExpense() {
      const date = document.getElementById("date").value;
      const category = document.getElementById("category").value;
      const description = document.getElementById("description").value;
      const amount = parseFloat(document.getElementById("amount").value);
      const recurring = document.getElementById("recurring").checked;

      if (!date || !category || !description || isNaN(amount)) {
        alert("Fill all fields correctly.");
        return;
      }

      expenses.push({ date, category, description, amount, recurring });
      localStorage.setItem("expenses", JSON.stringify(expenses));
      // Update recent categories
      if (category) {
        recentCategories = recentCategories.filter(c => c !== category);
        recentCategories.unshift(category);
        if (recentCategories.length > 5) recentCategories = recentCategories.slice(0, 5);
        localStorage.setItem("recentCategories", JSON.stringify(recentCategories));
        renderRecentCategories();
      }
      displayExpenses();

      // Clear input fields
      document.getElementById("date").value = "";
      document.getElementById("category").value = "";
      document.getElementById("description").value = "";
      document.getElementById("amount").value = "";
      document.getElementById("recurring").checked = false;
    }

    function displayExpenses() {
      const list = document.getElementById("expense-list");
      const totalDiv = document.getElementById("total");
      const warningDiv = document.getElementById("limit-warning");
      list.innerHTML = "";

      let total = 0;
      const filtered = expenses.filter(e => e.date.startsWith(currentMonth));
      filtered.forEach((e) => {
        total += e.amount;
        const item = document.createElement("div");
        item.className = "expense-item";
        item.innerText = `${e.date} | ${e.category} | ${e.description} | ‚Çπ${e.amount}` + (e.recurring ? " | üîÅ" : "");
        list.appendChild(item);
      });

      totalDiv.innerText = `Total: ‚Çπ${total.toFixed(2)}`;
      warningDiv.innerText = total > monthlyLimit ? `‚ö†Ô∏è Limit Exceeded by ‚Çπ${(total - monthlyLimit).toFixed(2)}` : '';
    }

    function downloadCSV() {
      const filtered = expenses.filter(e => e.date.startsWith(currentMonth));
      if (filtered.length === 0) {
        alert("No expenses to download for this month.");
        return;
      }

      let csv = "Date,Category,Description,Amount\n";
      filtered.forEach(e => {
        csv += `${e.date},${e.category},${e.description},${e.amount}\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `Expense_Report_${currentMonth}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // --- FRIEND TRANSACTIONS SECTION ---
    let friendTransactions = JSON.parse(localStorage.getItem("friendTransactions")) || [];
    let receivedTransactions = JSON.parse(localStorage.getItem("receivedTransactions")) || [];

    function addFriendTransaction() {
      const name = document.getElementById("friend-name").value;
      const desc = document.getElementById("friend-desc").value;
      const amount = parseFloat(document.getElementById("friend-amount").value);
      const date = document.getElementById("friend-date").value;

      if (!name || !desc || isNaN(amount) || !date) {
        alert("Fill all fields correctly.");
        return;
      }

      friendTransactions.push({ name, desc, amount, date });
      localStorage.setItem("friendTransactions", JSON.stringify(friendTransactions));
      displayFriendTransactions();

      document.getElementById("friend-name").value = "";
      document.getElementById("friend-desc").value = "";
      document.getElementById("friend-amount").value = "";
      document.getElementById("friend-date").value = "";
    }

    function displayFriendTransactions() {
      const list = document.getElementById("friend-list");
      const totalDiv = document.getElementById("friend-total");
      list.innerHTML = "";

      let total = 0;
      friendTransactions.forEach(t => {
        total += t.amount;
        const item = document.createElement("div");
        item.className = "expense-item";
        item.innerText = `${t.date} | To: ${t.name} | Reason: ${t.desc} | ‚Çπ${t.amount}`;
        list.appendChild(item);
      });

      totalDiv.innerText = `Total Given: ‚Çπ${total.toFixed(2)}`;
    }

    function addReceivedTransaction() {
      const name = document.getElementById("recv-friend-name").value;
      const desc = document.getElementById("recv-friend-desc").value;
      const amount = parseFloat(document.getElementById("recv-friend-amount").value);
      const date = document.getElementById("recv-friend-date").value;

      if (!name || !desc || isNaN(amount) || !date) {
        alert("Fill all fields correctly.");
        return;
      }

      receivedTransactions.push({ name, desc, amount, date });
      localStorage.setItem("receivedTransactions", JSON.stringify(receivedTransactions));
      displayReceivedTransactions();

      document.getElementById("recv-friend-name").value = "";
      document.getElementById("recv-friend-desc").value = "";
      document.getElementById("recv-friend-amount").value = "";
      document.getElementById("recv-friend-date").value = "";
    }

    function displayReceivedTransactions() {
      const list = document.getElementById("recv-friend-list");
      const totalDiv = document.getElementById("recv-friend-total");
      list.innerHTML = "";
      let total = 0;
      receivedTransactions.forEach((t) => {
        total += t.amount;
        const item = document.createElement("div");
        item.className = "expense-item";
        item.innerText = `${t.date} | ${t.name} | ${t.desc} | ‚Çπ${t.amount}`;
        list.appendChild(item);
      });
      totalDiv.innerText = `Total Received: ‚Çπ${total.toFixed(2)}`;
    }

    // --- DARK MODE ---
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      document.querySelectorAll('.card').forEach(card => card.classList.toggle('dark-mode'));
    }

    // --- CLEAR ALL DATA ---
    function clearAllData() {
      if (confirm('Are you sure you want to remove all data? This cannot be undone.')) {
        localStorage.clear();
        location.reload();
      }
    }

    function renderRecentCategories() {
      const container = document.getElementById("recent-categories");
      container.innerHTML = '';
      if (recentCategories.length === 0) return;
      recentCategories.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm btn-outline-primary me-1 mb-1';
        btn.innerText = cat;
        btn.onclick = () => { document.getElementById("category").value = cat; };
        container.appendChild(btn);
      });
    }

    // On page load, if limit is already set, hide limit area and show message
    window.onload = function() {
      if (currentMonth && monthlyLimit) {
        document.getElementById("limit-area").style.display = "none";
        const msg = document.getElementById("limit-message");
        msg.innerHTML = `<strong>Limit for the month: ‚Çπ${monthlyLimit.toFixed(2)}</strong>`;
        msg.style.display = "block";
        document.getElementById("change-limit-btn").style.display = "block";
      }
      displayExpenses();
      displayFriendTransactions();
      displayReceivedTransactions();
      renderRecentCategories();
    }
  </script>

</body>
</html>
